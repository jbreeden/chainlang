<!DOCTYPE html>

<html>
<head>
  <title>chainlang.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>chainlang.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*
 * Author: Jared Breeden
 * File: chainlang.js
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2013 Jared Breeden
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>chainlang</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> chainlang = module.exports;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><code>chainlang.create</code> accepts a <code>lang</code> parameter and returns
a <a href="#chain"><code>chain</code></a> constructor that is used to begin chained
expressions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>chainlang.create = <span class="keyword">function</span>(lang){
    <span class="keyword">if</span>(arguments.length !== <span class="number">1</span>){
        <span class="keyword">throw</span> <span class="string">"chainlang.create expects one argument: An object containing the methods of the new chain language"</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>theChain</code> is a per-language singleton. That is, each chained
expression will access data from the same &quot;chain&quot; object. This 
means that chains cannot be arbitrarily saved to variables and 
interleaved with other chain expressions of the same language.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> theChain = createChainableProxy(lang);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>_breaksChain</code> is used to break the chain and return a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    theChain._breaksChain = <span class="keyword">function</span>(returnValue){
        theChain.__break__ = <span class="literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>chain expression constructor</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The <code>chain</code> function is the constructor for chained expressions
of the new <code>chainlang</code> type. 
<a id="chain"></a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">chain</span><span class="params">(obj)</span>{</span>
        <span class="keyword">if</span>(arguments.length &gt; <span class="number">1</span>){
            <span class="keyword">throw</span> <span class="string">"Chain constructors can only accept one argument"</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Resetting the properties on <code>theChain</code> for the new expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        theChain._subject = obj;
        theChain._data = {};
        theChain._prev = <span class="literal">null</span>;
        theChain._nextLink = <span class="literal">null</span>;
        theChain.__break__ = <span class="literal">false</span>;
        theChain.__stack_height__ = <span class="number">0</span>;
        
        <span class="keyword">return</span> theChain;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Returning the <code>chain</code> constructor to the client of <code>chainlang.create</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> chain;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2>Privates</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>This function kicks off the recursive traversal of the language
object to create an object with chainable methods. (These are
essentially &quot;proxied&quot; versions of the methods found on the language object.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">createChainableProxy</span><span class="params">(language)</span>{</span>
    <span class="keyword">var</span> wrappers = [],
        chain = {};

    createChainableProxyNode(
        chain,
        chain, 
        language,
        wrappers);

    <span class="keyword">return</span> chain;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>This is the self-recursive method for construction of the chainable object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">createChainableProxyNode</span><span class="params">(node, chain, language, wrappers)</span>{</span>
    <span class="keyword">var</span> hasWrapper = hasWrapperMethod(language);

    <span class="keyword">if</span>(hasWrapper){
        wrappers.push(language[<span class="string">'_wrapper'</span>]);
    }


    <span class="keyword">for</span>(<span class="keyword">var</span> propName <span class="keyword">in</span> language){</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Properties named with a leading underscore are reserved for chain-level
semi-hidden data to avoid conflicts with language methods. So, for now
we&#39;ll just ignore any we come across. May want to throw an error later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span>(propName[<span class="number">0</span>] == <span class="string">"_"</span>){
            <span class="keyword">continue</span>;
        }

        <span class="keyword">var</span> prop = language[propName];
        <span class="keyword">if</span>(prop === <span class="literal">undefined</span> || prop === <span class="literal">null</span>){
           <span class="keyword">continue</span>;
        }
        
        <span class="keyword">var</span> makeNode = <span class="literal">true</span>;
        <span class="keyword">if</span>(<span class="keyword">typeof</span> prop == <span class="string">"function"</span>){
            node[propName] = createChainableProxiedMethod(chain, prop, wrappers);
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> prop == <span class="string">"object"</span>){
            node[propName] = {};
        }
        <span class="keyword">else</span>{
            makeNode = <span class="literal">false</span>;
            node[propName] = prop;
        }
        
        <span class="keyword">if</span>(makeNode){
            createChainableProxyNode(node[propName], chain, prop, wrappers);
        }
    }

    <span class="keyword">if</span>(hasWrapper){
        wrappers.pop();
    }
}

<span class="function"><span class="keyword">function</span> <span class="title">hasWrapperMethod</span><span class="params">(obj)</span>{</span>
    <span class="keyword">return</span> (
        obj[<span class="string">'_wrapper'</span>] !== <span class="literal">undefined</span>
        &amp;&amp; <span class="keyword">typeof</span> obj[<span class="string">'_wrapper'</span>] === <span class="string">"function"</span>
    );
}

<span class="function"><span class="keyword">function</span> <span class="title">createChainableProxiedMethod</span><span class="params">(chain, fn, wrappers)</span>{</span>
    <span class="keyword">var</span> i,
        proxiedMethod,
        wrappers = captureArray(wrappers);

    proxiedMethod = <span class="keyword">function</span>(){
        chain.__stack_height__ = wrappers.length;
        chain._prev = fn.apply(chain, arguments);
        <span class="keyword">return</span> returnValue(chain);
    }

    <span class="keyword">if</span>(wrappers.length &gt; <span class="number">0</span>){
        <span class="keyword">for</span>(i = wrappers.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">1</span>){
            proxiedMethod = createWrappedChainableMethod({
                    chain: chain,
                    wrapperFunction: wrappers[i],
                    proxiedMethod: proxiedMethod,
                    stackHeight: i
                });
        }
    }

    <span class="keyword">return</span> proxiedMethod;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>opt</code> options arguments should contain fields
<code>chain</code>, <code>wrapperFunction</code>, <code>proxiedMethod</code>, <code>stackHeight</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">createWrappedChainableMethod</span><span class="params">(opt)</span>{</span>
    <span class="keyword">return</span> <span class="keyword">function</span>(){
        opt.chain._prev = opt.wrapperFunction.call(opt.chain, opt.proxiedMethod, arguments);
        opt.chain.__stack_height__ = opt.stackHeight;
        
        <span class="keyword">return</span> returnValue(opt.chain);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Returns <code>chain.__return__</code> if <code>chain.__break__</code> is set,
or else returns the chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">returnValue</span><span class="params">(chain)</span>{</span>
    <span class="keyword">if</span>(chain.__stack_height__ === <span class="number">0</span>){
        <span class="keyword">var</span> nextLink = getNextLink(chain);
        chain._nextLink = <span class="literal">null</span>;
        
        <span class="keyword">if</span>(chain.__break__){
            <span class="keyword">return</span> chain._prev;
        }
        <span class="keyword">if</span>(nextLink){
            <span class="keyword">return</span> nextLink;
        }
    }
    
    <span class="keyword">return</span> chain;
}

<span class="function"><span class="keyword">function</span> <span class="title">getNextLink</span><span class="params">(chain)</span>{</span>
    <span class="keyword">if</span>(!chain._nextLink){
        <span class="keyword">return</span> <span class="literal">undefined</span>;
    }
    <span class="keyword">if</span>(!(<span class="keyword">typeof</span> chain._nextLink === <span class="string">'string'</span>)){
        <span class="keyword">throw</span> <span class="string">"_nextLink must be a string"</span>
    }
    
    <span class="keyword">var</span> trail = chain._nextLink.split(<span class="string">'.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Walk the trail from the chain root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> nextLink = chain;
    trail.forEach(<span class="keyword">function</span>(node){
        nextLink = nextLink[node];
    });
    
    <span class="keyword">return</span> nextLink;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>&quot;Captures&quot; an array. (i.e. makes a new array with the same references
 to avoid having the contents of a closed-over array changed externally)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">captureArray</span><span class="params">(array)</span>{</span>
    <span class="keyword">var</span> capturedArray = [];

    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; array.length; i += <span class="number">1</span>){
        capturedArray[i] = array[i];
    }

    <span class="keyword">return</span> capturedArray;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
